!function(){window.Dashboard=Ember.Application.create()}(),function(){Dashboard.HeaderController=Ember.ObjectController.extend({actions:{goToReports:function(){this.get("target").transitionTo("dash","dash_1")},goToDashboard:function(){this.get("target").transitionTo("dash","dash_2")},goBackToBoardReport:function(){this.get("target").transitionTo("dash","dash_2"),this.get("target").reset()},prepareForPrint:function(){window.print()}}})}(),function(){Dashboard.ModalController=Ember.ObjectController.extend({actions:{close:function(){return console.log("ModalController > Close"),this.send("closeModal")}}})}(),function(){Dashboard.PageController=Ember.ObjectController.extend({_pages:null,pages:function(){if(null!==this.get("_pages"))return this.get("_pages");var a=this;Dashboard.ReportModel.findAll().then(function(b){var c=b.annexes.findBy("ID","annex_b").pages;a.set("_pages",c)})}.property("_pages"),pageRAGTotals:function(){var a=this.get("pages");if(null!=a){var b={};a.forEach(function(a){for(var c=a.get("ragStatus"),d=0;d<c.length;d++){{var e=c[d];e.colour}void 0===b[d]?b[d]={colour:e.colour,count:e.count,previous:e.previous}:(b[d].count=parseInt(b[d].count,10)+parseInt(e.count,10),b[d].previous=parseInt(b[d].previous,10)+parseInt(e.previous,10))}}),b[1]={colour:"missing",count:"",previous:"N/A"},b[3]={colour:"missing",count:"",previous:"N/A"};var c=[];for(var d in b)c.push(b[d]);return c}return[]}.property("_pages"),_nhsEnglandRAGTotals:null,nhsEnglandRAGTotals:function(){var a=this;return null!=this.get("_nhsEnglandRAGTotals")?this.get("_nhsEnglandRAGTotals"):void Dashboard.PerformanceIndicatorModel.findAll().then(function(b){a.set("_nhsEnglandRAGTotals",b)})}.property("_nhsEnglandRAGTotals")}),Ember.Handlebars.helper("ragColour",function(a){var b=Handlebars.Utils.escapeExpression(a),c="G"===b?"green":"A"===b?"amber":"A/R"===b||"R"===b?"red":"blue";return new Ember.Handlebars.SafeString(c)})}(),function(){Dashboard.DashboardModel=Ember.Object.extend({_data:null,data:function(){if(null!=this.get("_data"))return this.get("_data");var a=null,b=this.get("CKANResourceID");switch(this.get("Type")){case"BoardReport":null!=b&&(a=this,Dashboard.ReportModel.find(b).then(function(b){a.set("_data",b)}));break;case"BoardReportDashboard":null!=b&&(a=this,Dashboard.ReportModel.find(b).then(function(b){var c=b.findBy("ID","annex_b"),d=c.pages,e=d.findBy("ID","page_1"),f=e.indicators;a.set("_data",f)}));break;case"Dashboard":if(null!=b){a=this;var c={resource_id:b};$.ajax({url:"http://54.154.11.196/api/action/datastore_search",data:c,dataType:"jsonp"}).then(function(b){var c=b.result,d=[];if(null!=c&&utils.isArray(c.records)){c.records.forEach(function(a){$.extend(a,$.parseJSON(a.Config)),delete a.Config;var b=Dashboard.WidgetModel.create(a);d.push(b)});var e=d.sortBy("Order");a.set("_data",e)}})}}return this.get("_data")}.property("_data")}),Dashboard.DashboardModel.reopenClass({find:function(a){return this.findAll().then(function(b){return b.filterBy("ID",a)[0]})},findAll:function(){var a={resource_id:"e8a418c8-c879-4dd9-b36f-ecb9b6d65678"};return $.ajax({url:"http://54.154.11.196/api/action/datastore_search",data:a}).then(function(a){var b=[],c=a.result;return c.records.forEach(function(a){var c=Dashboard.DashboardModel.create(a);b.push(c)}),b})}})}(),function(){Dashboard.DataRowModel=Ember.Object.extend({isAppendicesRow:function(){return this.get("Title").toString().startsWith("*")}.property()})}(),function(){Dashboard.IndicatorModel=Ember.Object.extend({targetValue:null,_currentValue:null,_currentVal:null,previousValue:null,_previousVal:null,_dataValues:null,_currentDate:null,currentValue:function(){return null!=this.get("_currentValue")?this.get("_currentValue"):void this.get("dataValues")}.property("_currentValue"),currentVal:function(){if(null!=this.get("_currentVal"))return this.get("_currentVal");var a=0,b=this.get("currentValue");return null!=b&&null!=b.value?(a=parseFloat(parseFloat(b.value).toPrecisionDigits(3)),this.set("_currentVal",a),this.get("_currentVal")):a}.property("currentValue"),previousVal:function(){if(null!=this.get("_previousVal"))return this.get("_previousVal");var a=0,b=this.get("previousValue");return null!=b&&null!=b.value?(a=parseFloat(parseFloat(b.value).toPrecisionDigits(3)),this.set("_previousVal",a),this.get("_previousVal")):a}.property("previousValue"),currentDate:function(){if(null!=this.get("_currentDate"))return this.get("_currentDate");var a=this.get("currentValue");if(null!=a&&null!=a.year){var b=a.year.cleanDateFormats();return this.set("_currentDate",b),this.get("_currentDate")}return""}.property("currentValue"),_periodOfCoverage:null,periodOfCoverage:function(){if(null!=this.get("_periodOfCoverage"))return this.get("_periodOfCoverage");var a=this.get("currentValue");if(null!=a){var b=a.period_of_coverage,c=this.get("RAGType");if("Constitutional"===c&&null!==b&&""!==b)this.set("_periodOfCoverage",b);else{var d=this.get("currentDate");this.set("_periodOfCoverage",d)}}return this.get("_periodOfCoverage")}.property("currentDate"),getRAGValue:function(){return null!==this.get("RAGValue")&&"%"===this.get("valueString")?100*this.get("RAGValue"):this.get("RAGValue")}.property("RAGValue"),chartID:function(){return"Chart"+this.get("ID")}.property(),hasValue:function(){var a=this.get("currentValue");return null==a?!1:null!=a.value&&-1===a.value.indexOf("T00:")?!0:!1}.property("currentValue"),dataValues:function(){if(null!=this.get("_dataValues"))return this.get("_dataValues");var a=this,b=["125","126","127","128","129","130","131","132","133","134","135","136","137","138","139","140","141","142","143","144","145","65"];-1!==b.indexOf(a.get("ID"))?$.ajax({url:'http://54.154.11.196/api/action/datastore_search_sql?sql=SELECT * from "ff58da5b-297e-478a-a3e8-65b54b82d840" WHERE "indicator_id" = \''+a.get("ID")+'\' ORDER BY "year" DESC '}).then(function(b){var c=b.result.records;return a.setProperties({_dataValues:c,_currentValue:c[0],previousValue:c[1]}),a.get("_dataValues")}):$.ajax({url:'http://54.154.11.196/api/action/datastore_search_sql?sql=SELECT * from "ed59dfc4-3076-4e84-806e-7a47d2321f36" WHERE "indicator_id" = \''+a.get("ID")+'\' ORDER BY "year" DESC '}).then(function(b){var c=b.result.records;return a.setProperties({_dataValues:c,_currentValue:c[0],previousValue:c[1]}),a.get("_dataValues")})}.property(),trend:function(){if(null!=this.get("currentValue")){var a=this.get("currentValue").value,b=this.get("previousValue").value,c=this.get("DesiredDirection");switch(c){default:return a===b?"even":a>b?"up":"down";case"Down":return a===b?"even":b>a?"up":"down"}}return"notrend"}.property("_ragColour","_currentValue"),_ragColour:null,ragColour:function(){if(null!==this.get("_ragColour"))return this.get("_ragColour");var a="blue",b=this.get("currentValue"),c=this.get("previousValue");if("Constitutional"===this.get("RAGType"))return this.calculateRAG();null==b||null==c||null===b.value||null===c.value?a="blue":(b=b.value,c=c.value);var d=1,e=b-c,f=e/c*100;return isNaN(f)||(-d>f?a="red":0>f?a="amber":d>=f?a="amberGreen":f>d&&(a="green")),this.set("_ragColour",a),a}.property("_currentVal","_previousVal"),valueString:function(){return"int"===this.get("ValueType")?"":this.get("ValueType")}.property("ValueType"),regionalInfo:function(){},calculateRAG:function(){var a="amber";if(null!=this.get("currentValue")){var b=this.get("currentValue").value,c=this.get("RAGValue");c="%"===this.get("valueString")?100*c:c;var d=c+1;if("%"!==this.get("valueString"))return b>c?"red":"green";b>d?a="green":c>b&&(a="red")}return a}}),Dashboard.IndicatorModel.reopenClass({values:null})}(),function(){Dashboard.PageModel=Ember.Object.extend({_rows:null,rows:function(){if(null===this.get("_rows")){var a=this;switch(this.get("Type")){case"page_finance":case"page_finance_table":case"page_supplimentary_business":case"page_supplimentary_risks":if(null===this.get("_rows")&&null!==this.get("CKANID")){var b=a.get("CKANID");$.ajax({url:'http://54.154.11.196/api/action/datastore_search_sql?sql=SELECT * from "'+b+'"'}).then(function(b){var c=[];b.result.records.forEach(function(a){var b=Dashboard.DataRowModel.create(a);c.push(b)}),a.setProperties({_rows:c})})}return a.get("_rows")}}return this.get("_rows")}.property("_rows"),_ragStatus:null,ragStatus:function(){if(null!==this.get("_ragStatus"))return this.get("_ragStatus");var a=[{colour:"red",count:utils.random(1,4),previous:utils.random(-6,-1)},{colour:"missing",count:"",previous:"N/A"},{colour:"amber",count:utils.random(3,11),previous:"+"+utils.random(1,6)},{colour:"missing",count:"",previous:"N/A"},{colour:"green",count:utils.random(10,18),previous:"+"+utils.random(4,10)}];return this.set("_ragStatus",a),this.get("_ragStatus")}.property("_ragStatus"),_data:null,data:function(){if(null===this.get("_data"))switch(this.get("Type")){case"page_finance":return null;case"page_finance_table":return null;case"page_supplimentary_business":return null;case"page_supplimentary_risks":var a=this;if(null===this.get("_data")&&null!==this.get("CKANID")){var b=this.get("CKANID");$.ajax({url:'http://54.154.11.196/api/action/datastore_search_sql?sql=SELECT * from "'+b+'"'}).then(function(b){var c,d,e={sections:[]};b.result.records.forEach(function(a){if("section"===a.Type)c={title:a.SectionTitle,groups:[]},e.sections.push(c);else if("group"===a.Type)d={title:a.GroupTitle,indicators:[]},c.groups.push(d);else if("indicator"===a.Type){var b=function(a){switch(a){case"A/R":return"redAmber";case"R":return"red";case"A":return"amber";case"A/G":return"amberGreen";case"G":return"green"}};a.Trend=a.Col3,a.RAG=a.Col4,a.mitigatedRAG=a.Col5,a.RAGCode=b(a.RAG),a.mitigatedRAGCode=b(a.mitigatedRAG),a.achieveDate=a.Col6,delete a.Col3,delete a.Col4,delete a.Col5,delete a.Col6,d.indicators.push(a)}}),a.set("data",e),console.log(e)})}return a.get("_data")}return this.get("_rows")}.property("_data")})}(),function(){Dashboard.PerformanceIndicatorModel=Ember.Object.extend({}),Dashboard.PerformanceIndicatorModel.reopenClass({findAll:function(){var a={resource_id:"54d570f3-c72c-42d6-84d8-38b43ff28fe1"};return $.ajax({url:"http://54.154.11.196/api/action/datastore_search",data:a,dataType:"jsonp"}).then(function(a){var b=a.result.records,c=[],d={Red:0,AmberRed:0,Amber:0,AmberGreen:0,Green:0,Missing:0},e={Red:0,AmberRed:0,Amber:0,AmberGreen:0,Green:0,Missing:0},f=_.groupBy(b,"ID");_.each(f,function(a){var b=_.sortBy(a,"Date").reverse(),f=_.first(b),g=b[1],h=Dashboard.PerformanceIndicatorModel.create({Title:f.Title,ID:f.ID,Current:f,Previous:g});d.Red+=parseInt(f.Red,10),d.AmberRed+=parseInt(f.AmberRed,10),d.Amber+=parseInt(f.Amber,10),d.AmberGreen+=parseInt(f.AmberGreen,10),d.Green+=parseInt(f.Green,10),d.Missing+=parseInt(f.Missing,10),e.Red+=parseInt(g.Red,10),e.AmberRed+=parseInt(g.AmberRed,10),e.Amber+=parseInt(g.Amber,10),e.AmberGreen+=parseInt(g.AmberGreen,10),e.Green+=parseInt(g.Green,10),e.Missing+=parseInt(g.Missing,10),c.push(h)});var g=Dashboard.PerformanceIndicatorModel.create({Title:"NHS England Totals",ID:"999",Current:d,Previous:e});return c.push(g),c})}})}(),function(){Dashboard.ReportModel=Ember.Object.extend({}),Dashboard.ReportModel.reopenClass({find:function(a){var b={resource_id:a};return $.ajax({url:"http://54.154.11.196/api/action/datastore_search",data:b,dataType:"jsonp"}).then(function(a){var b=a.result,c={};return b.records.forEach(function(a){var b=a.Type.split("_")[0];c[b]||(c[b]=[]),c[b].push(a)}),c.page.forEach(function(a){var b=[],d=c.indicator.filterBy("ParentID",a.ID);d.forEach(function(a){var c=Dashboard.IndicatorModel.create(a);b.push(c)}),a.indicators=b}),c.annex.forEach(function(a){var b=c.page.filterBy("ParentID",a.ID),d=[];b.forEach(function(a){var b=Dashboard.PageModel.create(a);d.push(b)}),a.pages=d}),c.annex})},findAll:function(){var a={resource_id:"f441a675-1d3c-43d8-aa8d-c1059381c0e8"};return $.ajax({url:"http://54.154.11.196/api/action/datastore_search",data:a,dataType:"jsonp"}).then(function(a){var b=a.result,c={};b.records.forEach(function(a){var b=a.Type.split("_")[0];c[b]||(c[b]=[]),c[b].push(a)}),c.page.forEach(function(a){var b=[],d=c.indicator.filterBy("ParentID",a.ID);d.forEach(function(a){var c=Dashboard.IndicatorModel.create(a);b.push(c)}),a.indicators=b}),c.annex.forEach(function(a){var b=c.page.filterBy("ParentID",a.ID),d=[];b.forEach(function(a){var b=Dashboard.PageModel.create(a);d.push(b)}),a.pages=d});var d=Dashboard.ReportModel.create({title:"Board Report January 2015",annexes:c.annex});return d})}})}(),function(){Dashboard.WidgetModel=Ember.Object.extend({_data:null,data:function(){if(null!=this.get("_data"))return this.get("_data");switch(this.get("Type")){case"NHSIndicator":return null===this.get("IndicatorID")?new Error("No indicator id for Widget > NHSIndicator "):(this.set("_data",Dashboard.IndicatorModel.create({ID:this.get("IndicatorID")})),this.get("_data"))}}.property("_data")}),Dashboard.WidgetModel.reopenClass({})}(),function(){Dashboard.DashRoute=Ember.Route.extend({model:function(a){var b=a.dashID;return Dashboard.DashboardModel.find(b)},afterModel:function(){var a=this;a.renderTemplate=function(){var b=a.currentModel;if(null!=b){var c=b.Type.decamelize();a.render(c,{model:b});var d=this.controllerFor("header");d.set("model",b),a.render("header_"+c,{into:"application",outlet:"header",view:"header",controller:d,model:b})}}},activate:function(){this.renderTemplate()},_modal:null,_modalActive:!1,actions:{toggleFooter:function(a){this.toggleFooter(a)},openModal:function(a){return this.render(a,{into:"application",outlet:"modal",view:a})},closeModal:function(){return console.log("DashRoute > closeModal"),this.disconnectOutlet({outlet:"modal",parentView:"application"})}},toggleFooter:function(a){return this.render(a,{into:"application",outlet:"footer"})}})}(),function(){Dashboard.IndexRoute=Ember.Route.extend({model:function(){return Dashboard.DashboardModel.findAll()},afterModel:function(a){a.get("length")>0&&this.transitionTo("dash",a.get("firstObject").get("ID"))}})}(),function(){Dashboard.AnnexRoute=Ember.Route.extend({model:function(a){var b=a.annexID;return Dashboard.ReportModel.findAll().then(function(a){return a.annexes.findBy("ID",b)})}}),Dashboard.PageRoute=Ember.Route.extend({model:function(a){var b=this.modelFor("annex").ID,c=a.pageID;return Dashboard.ReportModel.findAll().then(function(a){var d=a.annexes.findBy("ID",b).pages.findBy("ID",c);return d})},afterModel:function(){var a=this;a.renderTemplate=function(){var b=a.currentModel;a.render(b.Type,{outlet:"",into:"application"});var c=a.controllerFor("header");c.set("model",b),a.render("header_board_report_page",{into:"application",outlet:"header",view:"header",controller:c,model:b})}},setupController:function(a,b){a.set("model",b)}})}(),function(){Dashboard.HeaderLogoComponent=Ember.Component.extend({})}(),function(){Dashboard.HeatMapComponent=Ember.Component.extend({isDrawn:!1,draw:function(a){var b="#"+a.get("chartID"),c=a.get("valueString"),d=a.get("_dataValues"),e=0,f=0,g=Math.max.apply(d,$.map(d,function(a){return a.value}));f=g;var h=parseFloat(a.get("RAGValue"));if("%"===c){g/=100;var i=Math.min.apply(d,$.map(d,function(a){return a.value}));i/=100,i>h&&(i=h),h>g&&(g=h),i-=.01,g+=.01,f=g,e=i}var j=d.map(function(a){var b=-1===a.year.indexOf("T")?a.year:a.year.substr(0,a.year.indexOf("T"));return b}),k=d.map(function(a){return"%"===c?a.value/100:a.value}),l=[];if("Constitutional"===a.get("RAGType")){var m=h+.0099,n=h+.01,o=.3;l="%"===c?[{axis:"y",start:0,end:h,"class":"regionYR",opacity:o},{axis:"y",start:h,end:m,"class":"regionYA",opacity:o},{axis:"y",start:n,"class":"regionYG",opacity:o}]:[{axis:"y",start:0,end:h,"class":"regionYG",opacity:o},{axis:"y",start:h,"class":"regionYR",opacity:o}]}j.unshift("x"),k.unshift("Indicator Value"),c3.generate({bindto:b,legend:{hide:!0},data:{x:"x",columns:[j,k]},axis:{x:{type:"timeseries",tick:{format:"%b %Y"}},y:{tick:{format:"%"===c?d3.format(".1%"):null},min:e,max:f,padding:{top:18,bottom:0}}},grid:{y:{show:!0}},point:{focus:{expand:{r:5}}},padding:{right:20},regions:l}),d3.select(".c3-axis.c3-axis-x").attr("clip-path",""),this.set("isDrawn",!0)},didInsertElement:function(){var a=this.get("controller.data"),b="#"+a.get("chartID"),c=$(b),d=c.parents(".accordionContent"),e=d.siblings('div[data-indicator-id="'+a.get("ID")+'"]'),f=this;e.click(function(){f.get("isDrawn")||setTimeout(function(){f.draw(a)},1e3)})}})}(),function(){Dashboard.ModalDialogComponent=Ember.Component.extend({didInsertElement:function(){this.get("parentIsView")===!0&&this.set("targetObject",this.get("parentView"))},actions:{close:function(){return console.log("ModalDialogComponent > Close"),this.sendAction()}}})}(),function(){Dashboard.WidgetBoardReportIndicatorComponent=Ember.Component.extend({needs:"dashboard",dashboard:Ember.computed.alias("controllers.dashboard"),widget:null,indicator:null,chartModal:null,didInsertElement:function(){var a=this.get("controller.widget");this.set("widget",a)},actions:{toggleGraph:function(){this.displayGraphPopup()},toggleMeta:function(){this.displayMeta(),this.sendAction("action","Testy McTest test")},openModal:function(a,b){this.sendAction("action",a,b)}},displayFlip:function(){},displayMeta:function(){var a=null,b=this.$(),c=b.parents(".dashboard");if(null==this.get("chartModal")){var d=$('<div class="chartModal" id="'+this.get("widget.ID")+'"></div>');a=d.appendTo(c),b.addClass("modalHighlighted"),this.set("chartModal",a)}else{var e=$(".chartModal:visible");e.length>0?e.first().attr("ID")===this.get("widget.ID")?e.fadeOut("fast"):(a=this.get("chartModal"),e.fadeOut("fast",function(){a.fadeIn("fast")})):this.get("chartModal").fadeIn("fast")}},displayGraphPopup:function(){if(null==this.get("chartModal")){var a=$('<div class="chartModal"><h2>THIS IS THE CHART: '+this.get("widget.IndicatorID")+"</h2></div>");this.set("chartModal",a.appendTo(this.$().parents(".dashboard"))),this.populateChart()}$(".chartModal:visible").length>0?$(".chartModal:visible").fadeOut("fast",function(){this.get("chartModal").fadeToggle("fast")}):this.get("chartModal").fadeToggle("fast")},populateChart:function(){Dashboard.HeatMapComponent.create({data:this.get("widget")}).appendTo(this.get("chartModal"))}})}(),function(){Dashboard.ApplicationView=Ember.View.extend({})}(),function(){Dashboard.BoardReportView=Ember.View.extend({templateName:"dashboard_BoardReport",didInsertElement:function(){}})}(),function(){Dashboard.BoardReportDashboardView=Ember.View.extend({templateName:"dashboard_Dashboard",didInsertElement:function(){var a=this;Ember.run.schedule("afterRender",function(){a.modelChanged()})},modelChanged:function(){if(this.$()){var a=this.get("controller.model");null!=a.get("data")&&Ember.run.schedule("afterRender",function(){dashWrapper.initGridster()})}}.observes("controller.model.data.@each")})}(),function(){Dashboard.DashboardView=Ember.View.extend({templateName:"dashboard_Dashboard",didInsertElement:function(){var a=this;Ember.run.schedule("afterRender",function(){a.modelChanged()})},modelChanged:function(){if(this.$()){var a=this.get("controller.model");null!=a.get("data")&&Ember.run.schedule("afterRender",function(){dashWrapper.initGridster()})}}.observes("controller.model.data.@each")})}(),function(){Dashboard.HeaderView=Ember.View.extend({owlCarousel:null,_templateName:"header_standard"})}(),function(){Dashboard.IndexView=Ember.View.extend({templateName:"index",owl:null})}(),function(){Dashboard.WidgetMetaView=Ember.View.extend({templateName:"widget_meta",actions:{close:function(){console.log("WidgetMetaView > Close"),this.get("controller").send("closeModal")}}})}(),function(){Dashboard.Router.map(function(){this.resource("dash",{path:"/dash/:dashID"},function(){this.resource("annex",{path:"/annex/:annexID"},function(){this.resource("page",{path:"page/:pageID"})})})}),Dashboard.Router.reopen({rootURL:"/blog/"})}(),function(){Ember.View.reopen({didInsertElement:function(){this._super(),Ember.run.scheduleOnce("afterRender",this,this.afterRenderEvent)},afterRenderEvent:function(){}})}();